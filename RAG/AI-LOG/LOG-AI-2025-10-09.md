---
node_id: LOG-AI-2025-10-09
tags:
  - AI-log
  - development-summary
  - authoring
  - contracts
  - lua
closed_tickets:
  - AI-IMP-026
  - AI-IMP-027
created_date: 2025-10-09
related_files:
  - rag/epic/AI-EPIC-XXX-cli-v1-authoring-contracts.md
  - RAG/AI-IMP/AI-IMP-028-template-precedence-and-prompt-wiring.md
  - RAG/AI-IMP/AI-IMP-029-frontmatter-constraints-engine-and-readonly.md
  - RAG/AI-IMP/AI-IMP-030-body-heading-policy-and-loc-on-validate.md
  - src/commands/ai_new/start.rs
  - src/commands/new_helpers.rs
  - src/commands/lua_integration.rs
  - tests/integration_ai_index_plan.rs
  - tests/integration_ai_index_apply.rs
  - tests/integration_ai_new.rs
confidence_score: 0.83
---

# 2025-10-09-LOG-AI-cli-authoring-contracts-wiring

## Work Completed
Implemented planning artifacts and began Phase 1 of AI-IMP-028 (template precedence and prompt wiring) to align the AI authoring flow with contracts:
- Added a detailed epic locking template precedence, token policy, frontmatter/body validators, and wikilinks/edges work (rag/epic/AI-EPIC-XXX-cli-v1-authoring-contracts.md).
- Drafted first three IMP tickets for Phase 1–3: 028 (template precedence + prompt wiring), 029 (frontmatter constraints engine + readonly), 030 (body heading policy + LOC-on-validate).
- Removed legacy `ai-index-*` aliases and updated tests/help/README accordingly.
- Converted repo scaffolds to canonical `{{frontmatter}}` tokens and added `{{filename}}` variable support in the renderer.
- Enriched Lua overlay integration with `template_prompt`/`template_note` surfaces and utility/clock helpers; began integrating precedence in `ai_new start`.

## Session Commits
- docs: add cli authoring epic planning (epic + three IMP tickets); update alias tests to reflect removal.
- Code changes (uncommitted earlier in the session were finalized into a passing commit after fixing failing tests):
  - Removed alias dispatch; adapted tests in integration_ai_index_{plan,apply}.rs.
  - Renderer changes in new_helpers.rs for `{{frontmatter}}`, `{{filename}}`, and token substitution; tightened frontmatter injection to avoid duplicates when FM keys already present in templates.
  - Lua integration: added `template_prompt`/`template_note` and `ctx.util`/`ctx.clock`.
  - Began wiring precedence in ai_new/start.rs (instructions and body rendered from Lua/TOML/scaffold per policy).

## Issues Encountered
- Alias removal broke existing CI tests expecting deprecation warnings; updated tests to assert unknown-subcommand instead (exit 2). Resolved.
- Token migration: switching scaffolds from `((frontmatter))` to `{{frontmatter}}` required updating README examples and renderer logic. Ensured repo `.md` templates begin with `---` after frontmatter injection.
- Frontmatter duplication: early renderer logic always injected default tags/status/depends_on causing duplicate keys when templates already define them (notably EPIC). Adjusted frontmatter builder to only insert defaults when the template body doesn’t declare the keys.
- Lua prompt precedence: initial tests showed fallback instructions because Lua overlay code wasn’t being evaluated; investigation revealed our overlay loader returns a table that must be set in globals as `overlay` before hooks are read. We confirmed the loader’s behavior and updated ai_new/start to call the new hooks; still finalizing the instructions path to render variables in the prompt string.
- TOML inline triple-quote in tests: TOML multiline strings were malformed initially; switched to `"""..."""` to embed templates without escapes.

## Tests Added
- Updated ai index alias tests to assert removal (unknown-subcommand) rather than deprecation warnings.
- Extended integration_ai_new.rs:
  - Contract guidance coverage: confirms frontmatter injection, default keys present when needed, and headings/comments intact.
  - Template precedence (Lua and TOML) new tests: verify `.instructions` comes from Lua/TOML and `.noteTemplate` respects precedence. These are currently failing until we complete precedence wiring in ai_new/start.

## Next Steps
- Finish AI-IMP-028 wiring:
  1) Complete `ai_new/start.rs` precedence for instructions and body (Lua → TOML → repo `.md` → fallback) and ensure variable expansion for `.instructions`.
  2) Verify frontmatter builder avoids duplicates with schema templates (ADR/IMP/EPIC) and adjust if templates define keys under the frontmatter block.
  3) Finalize tests `ai_new_template_precedence_prefers_lua` and `ai_new_template_precedence_prefers_toml_when_no_lua` (they currently fail due to fallback instructions; body precedence works locally when overlay resolves).
- Then begin AI-IMP-029: extend SchemaRule (enum/globs/integer/float) and add readonly enforcement in submit; enrich StartResponse constraints.
- Document precedence and `RAG/ADR` defaults in README after 028 passes.

References to review before resuming:
- contracts/v1/config/user_config/templates/ADR.toml (prompt/note sections, validators)
- contracts/v1/config/user_config/templates/ADR-concept.lua/.fnl (hooks surface, ctx)
- RAG/ADR/ADR-003d-v1.2-locked-CLI-commands.md (linking of ai new start/submit rules)

Blocking risks:
- Overlay precedence edge cases: ensure user overlay overrides repo overlay consistently.
- Token migration ripple effects in any downstream consumer relying on `((frontmatter))`.

