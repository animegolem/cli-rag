---
node_id: LOG-AI-2025-09-14
tags:
  - AI-log
  - development-summary
  - ci
  - contracts
  - lua
  - overlays
  - hooks
  - validate
  - authoring
closed_tickets:
  - AI-IMP-007
  - AI-IMP-008
created_date: 2025-09-14
related_files:
  - .github/workflows/ci.yml
  - Cargo.toml
  - contracts/global-conventions.md
  - docs/RAG/BRIDGE_PLAN_V1.md
  - docs/RAG/BRIDGE_PLAN_V2.md
  - docs/RAG/AI-IMP/AI-IMP-007-lua-overlay-loader-and-no-lua.md
  - docs/RAG/AI-IMP/AI-IMP-008-lua-hooks-validation-and-new.md
  - docs/RAG/AI-IMP/AI-IMP-009-ai-index-plan.md
  - docs/RAG/AI-IMP/AI-IMP-010-ai-index-apply-cache-and-tags.md
  - docs/RAG/AI-IMP/AI-IMP-011-surface-cleanup-and-capability-gating.md
  - docs/RAG/AI-IMP/AI-IMP-012-ci-gates-for-ai-index-and-lua-smoke.md
  - docs/RAG/AI-IMP/AI-IMP-013-config-versioning-and-exposure.md
  - src/config/loader.rs
  - src/config/lua.rs
  - src/commands/lua_integration.rs
  - src/commands/info.rs
  - src/commands/validate_cmd.rs
  - src/commands/new.rs
  - tests/integration_lua_overlay.rs
  - tests/integration_lua_validate.rs
  - tests/integration_lua_new.rs
confidence_score: 0.88
---

# 2025-09-14-LOG-AI-ci-and-lua-overlay-hook-integration

## Work Completed
- CI: Fixed E120 duplicate schema name regression by consolidating schema setup in the fixture step and guarding against duplicates; added explicit reindex (validate) before graph/path/ai get steps to avoid "ADR not found" issues.
- Plans: Added a v1 status checkpoint to BRIDGE_PLAN_V1.md and authored BRIDGE_PLAN_V2.md (Lua overlay/versioning, AI Index plan/apply, surface cleanup, capability gating, config_version exposure).
- Tickets: Created AI-IMP-007..013 to map the v2 scope; closed AI-IMP-007 and AI-IMP-008 upon implementation.
- Lua Overlays (AI-IMP-007):
  - Added global --no-lua and CLI_RAG_NO_LUA=1.
  - Implemented overlay discovery (repo .cli-rag.lua, user ~/.config/cli-rag/config.lua) and surfaced overlaysEnabled in info; wrote overlays provenance in resolved.json.
  - Added integration tests for overlays on/off and resolved snapshot.
- Lua Hooks (AI-IMP-008):
  - validate(note, ctx): wired via vendored mlua; merged diagnostics into outputs as LUA[CODE]: msg and mapped codes.
  - new: integrated id_generator(schema, ctx) and render_frontmatter(schema, title?, ctx) to override IDs and merge FM.
  - Extracted helpers into src/commands/lua_integration.rs to keep files within line-length guard.
  - Updated hook signatures in contracts/global-conventions.md.

## Issues Encountered
- CI churn: shared temp config caused duplicate ADR schemas; fixed by consolidating schema setup and reindexing after fixture writes.
- Unified index preference: graph/path/readers prefer unified index; without reindex, newly written notes weren't visible. Resolved by invoking validate between fixture writes and reads.
- Lua build/runtime: chose mlua with vendored Lua to avoid system dependencies on CI; careful with chunk ownership and Lua lifetimes; extracted Lua logic to helpers to pass clippy and line-length guard.
- Diagnostics mapping: ensured LUA diagnostics carry codes and are recognized by classify_code to align with validate_result schema.

## Tests Added
- tests/integration_lua_overlay.rs: overlaysEnabled true with repo overlay; false with --no-lua and env var; resolved.json contains overlays.
- tests/integration_lua_validate.rs: validate() hook returns LUA_TEST warning; surfaced in JSON diagnostics.
- tests/integration_lua_new.rs: id_generator and render_frontmatter hooks produce ADR-999 and merge status/tags.
- CI workflow updated to prevent schema duplication and to reindex before graph/path/ai get, exercising end-to-end contract checks.

## Next Steps
- AI Index (AI-IMP-009/010): implement plan/apply surfaces, source index hashing, deterministic clusters, cache write, optional tag writes; add CI schema gates (AI-IMP-012).
- Capability gating: flip info.capabilities.aiIndex to false until plan/apply land; remove legacy topics/group surfaces (AI-IMP-011).
- Config versioning (AI-IMP-013): parse config_version from TOML and expose through info/resolved.
- Lua docs: expand global-conventions with minimal examples for validate/new hooks and clarified ctx fields as they evolve.

## Commits
- 2815c2d fix: suppress unused import warning in new.rs (lua types)
- b6b528f test(lua): add integration tests for overlay discovery and --no-lua; mark IMP-007 complete
- 6c04cb7 feat(lua): add --no-lua flag, overlay discovery, overlaysEnabled in info, overlays provenance in resolved snapshot; update IMP-007 progress
- 4ad7781 docs: capture config versioning exposure (AI-IMP-013) and add goal to v2 plan
- 4fb889d docs: add AI-IMP tickets for v2 scope (Lua overlays/hooks, ai index plan/apply, surface cleanup, CI gates)
- d115320 docs: mark v1 status checkpoint; add Bridge Plan v2 focusing on Lua overlay + AI Index + surface cleanup
- 1d5a27e ci: reindex before ai get; fix ADR-150 not found in unified index
- efad316 ci: reindex after fixture writes; ensure graph/path see new ADRs
- 25b7beb ci: consolidate schema setup; avoid E120 by defining ADR/IMP once in fixture config
