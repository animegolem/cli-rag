---
node_id: LOG-AI-2025-09-13
tags:
  - AI-log
  - development-summary
  - contracts
  - search
  - gtd
  - ai-get
  - watch
  - ci
  - unified-index
closed_tickets:
  - AI-IMP-004
  - AI-IMP-005
  - AI-IMP-006
created_date: 2025-09-13
related_files:
  - src/commands/search.rs
  - src/commands/search_gtd.rs
  - src/commands/get.rs
  - src/discovery/unified.rs
  - src/watch.rs
  - tests/integration_get_ai_neighbors.rs
  - tests/integration_watch_ndjson.rs
  - contracts/v1/cli/search_result.schema.json
  - .github/workflows/ci.yml
  - scripts/ci-fixtures-check.sh
  - Justfile
confidence_score: 0.88
---

# 2025-09-13-LOG-AI-imp-004-005-006-ci-fixes

## Work Completed
- Search: added protocolVersion to JSON envelope; default to notes-only; implemented GTD box parsing (`[@TODO:rank=..:due=..]`), byte-offset spans, stable IDs via FNV64; kanban hashing; preserved filters and deterministic sort.
- ai get: aligned `--format json` to contract (protocolVersion, retrievalVersion, neighbor styles metadata|outline|full, depth/fanout policies). Added outline extraction and deterministic neighbor ordering.
- Watch: NDJSON handshake `{event:"watch_start",protocolVersion:1}` and standardized event envelopes; added integration test and CI handshake check.
- Unified index reader: now preserves frontmatter in AdrDoc to keep search/emitters consistent when reading from unified index.
- CI hardening: replaced all fragile printf with heredocs; rebuilt unified index after writing fixtures; exported env for Python; standardized v1 schema paths.
- Docs: updated bridge plan statuses; created/closed IMP-005 and IMP-006; marked IMP-004 complete.
- Local tooling: added `scripts/ci-fixtures-check.sh` and Just `ci-check` to mirror key CI assertions locally.

## Issues Encountered
- CI-only regression: search prefers unified index; unified reader dropped frontmatter, so kanban emitters didn’t trigger, causing assertions to fail remotely while local scans passed.
- Shell pitfalls: printf with leading `---` in frontmatter tripped `printf: -- invalid option` on runners; replaced with heredocs.
- Env propagation: watch handshake Python snippet couldn’t see `WORKDIR` without `export`.
- Lint/format: clippy `too_many_arguments`, manual clamp, and a zombie process in an integration test; rustfmt line-wrap nits; line-length guard breached by a large file.

## Tests Added
- `tests/integration_get_ai_neighbors.rs`: verifies metadata vs outline neighbor styles and exit code 2 for `neighbor-style=full` with `depth>1`.
- `tests/integration_watch_ndjson.rs`: asserts first line handshake event and cleans up child process.
- Search GTD: extended tests for GTD box (`rank`→`priorityScore`, `due`→`dueDate`, `span`) and gated kinds with `--kind`.
- Local CI mirror: `scripts/ci-fixtures-check.sh` validates info/validate shapes, search (note, todo+kanban), and ai get JSON against the live binary with unified index.

## Next Steps
- Optionally wire `just ci-check` into the pre-commit hook to fail locally on contract-path regressions before push.
- Implement Lua overlay/versioning and `--no-lua` for ResolvedConfig emission.
- Add AI Index plan/apply basics (plan/apply contracts, hashing/tag write policy) per bridge plan.
- Consider search scoring refinements and neighbor outline tuning based on dogfooding; expand local fixtures script with jsonschema checks if needed.

