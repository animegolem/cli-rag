---
node_id: LOG-AI-2025-09-11
tags:
  - AI-log
  - development-summary
  - contracts
  - cli
  - validation
  - ci
  - windows
  - tests
closed_tickets: []
created_date: 2025-09-11
related_files:
  - AGENTS.md
  - README.md
  - .githooks/pre-commit
  - .github/workflows/ci.yml
  - src/cli.rs
  - src/bin/cli-rag.rs
  - src/commands/mod.rs
  - src/commands/info.rs
  - src/commands/validate_cmd.rs
  - src/commands/init.rs
  - tests/integration_info.rs
  - tests/integration_cycle_policy.rs
  - tests/integration_validate_json.rs
  - tests/integration_init_schema.rs
  - contracts/v1/config/resolved_config.json
  - contracts/v1/cli/info.schema.json
  - contracts/v1/cli/validate_result.schema.json
  - contracts/v1/index/index.schema.json
  - contracts/v1/config/user_config/cli-rag.toml
  - contracts/v1/config/user_config/templates/ADR.toml
  - contracts/v1/config/user_config/templates/ADR-concept.lua
  - docs/RAG/BRIDGE_PLAN_V1.md
  - docs/RAG/IMP-ADR/AI-IMP-001-contracts-ci-bootstrap.md
confidence_score: 0.92
---

# 2025-09-11-log-ai-phase-1-contracts-ci

## Work Completed
- Locked Phase 1 of the contracts-first refactor: renamed Doctor → Info and aligned `info --format json` to `contracts/v1/cli/info.schema.json` (protocolVersion, config, index, cache, capabilities).
- Reworked `validate --format json` to emit `{ ok, docCount, diagnostics:[{severity,code,msg,path?}] }` per `contracts/v1/cli/validate_result.schema.json`.
- Wrote `.cli-rag/resolved.json` snapshot after successful validate; formalized `contracts/v1/config/resolved_config.json` (enumerated validate.frontmatter/body/edges/gtd; removed defaultMaxNodes).
- Added “Contracts Compliance (Phase 1)” CI job validating `info`, `validate --dry-run`, and `resolved.json` against schemas; fixed YAML heredocs (quoted + indented with argv passing).
- Updated AGENTS.md with “Contracts‑First Development”, “Refactor Boldly (Alpha)”, and `_DEPRECATED` marker policy; added Bridge & Build Plan v1 with CI rollout phases.
- Normalized Windows TOML import paths in `init --separate` (forward slashes) and fixed integration tests; relaxed an overly strict `index.path` assertion.
- Enhanced pre-commit hook to run tests locally (opt-out via `PRECOMMIT_SKIP_TESTS=1`).
- Addressed clippy lint (`to_string` in println! args) and stabilized formatting across tests.

## Issues Encountered
- Pre-commit friction: rustfmt --check flagged test assertion wrapping; resolved by adopting rustfmt-preferred forms and avoiding manual “ping-pong”.
- CI YAML errors: heredoc blocks not indented under `run: |`; fixed by quoting delimiter (<<'PY'), indenting content, and passing schema/data via argv.
- Cross‑platform paths: Windows backslashes leaked into TOML import; normalized to `.cli-rag/templates/<NAME>.toml` for portable configs.
- Test drift: integration tests expected legacy `{errors,warnings}`; updated to new `diagnostics` envelope and relaxed brittle path assertions.
- Clippy: flagged `.to_string()` in `println!` args; removed and formatted `&str` directly.

## Tests Added
- Updated integration tests to match contracts:
  - `integration_info.rs`: asserts presence/shape of `protocolVersion`, `config`, `index`, `cache`, `capabilities`.
  - `integration_validate_json.rs`: verifies `{ ok, docCount, diagnostics: [] }` envelope and groups write.
  - `integration_cycle_policy.rs`: checks W240/E240 via unified diagnostics.
  - `integration_init_schema.rs`: validates inline/separate scaffolds, import idempotency, and template stubs across platforms.

## Next Steps
- Phase 2: unify index writing (single authoritative file), include `edges.kind` and `locations`, and validate against `contracts/v1/index/index.schema.json` in CI.
- Phase 3–5: align `graph`/`path`/`search` outputs to contracts; extend CI with their validators; implement `get --format ai` neighbors/style policies; wire `ai index` plan/apply basics.
- Emit a fuller ResolvedConfig snapshot from the loader (Lua overlay/versioning), and surface `luaApiVersion`/`configVersion` in `info`.
- Continue cleaning legacy docs references while keeping contracts authoritative; deprecate Justfile or mark targets `_DEPRECATED` if retained.

