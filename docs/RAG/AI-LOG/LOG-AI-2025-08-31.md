---
node_id: LOG-AI-2025-08-31
tags:
  - AI-log
  - development-summary
  - cli
  - templating
  - validation
  - config
  - acp
closed_tickets:
  - IMP-AI-004
  - IMP-AI-009
  - IMP-AI-010
  - IMP-AI-012
created_date: 2025-08-31
related_files:
  - src/commands/new.rs
  - src/cli.rs
  - src/bin/cli-rag.rs
  - src/config/loader.rs
  - src/config/schema.rs
  - src/config/template.rs
  - src/commands/validate_cmd.rs
  - src/validate.rs
  - src/commands/path.rs
  - src/watch.rs
  - src/protocol.rs
  - tests/integration_new.rs
  - tests/integration_init_schema.rs
  - tests/integration_cycle_policy.rs
  - docs/RAG/IMP-AI/IMP-AI-012-acp-alignment-surfaces.md
  - docs/RAG/IMP-AI/IMP-AI-004-validator-error-codes-and-policies.md
  - docs/RAG/IMP-AI/IMP-AI-009-split-config-module.md
  - docs/RAG/IMP-AI/IMP-AI-010-split-discovery-module.md
confidence_score: 0.88
---

<!-- Fill out the YAML Frontmatter in full.  --> 
<!-- Review the chat history and identify all worked tickets. -->
<!-- Review for kanban_status: completed. Tag any major concepts or systems. --> 
<!-- Identify major files edited in the session. Use git to validate. --> 
<!-- Provide your confidence in the accuracy and completeness of the generated log on a scale of 0.0 to 1.0. --> 
<!-- Fill out all headings below. Do not remove these bounded comments. --> 
<!-- Be professional in the style of a corporate ticket. Be concise but complete. --> 
<!-- replace {{tags}}. {LOC|X} should be replaced by your actual output and indicates the maximum lines per heading. --> 

# 2025-08-31-log-ai-imp-007-004-acp-alignment


## Work Completed
<!-- What work was completed this session in brief? -->
- Implemented new command with templating, id generation, --edit, --dry-run, --print-body, and --dest-base selection.
- Added minimal template engine tokens: {{id}}, {{title}}, {{date}}, {{time}}, {{LOC|N}}, and ((frontmatter)) injection; ensured YAML id matches computed id.
- Added filename templating: CLI flag and per-schema filename_template fallback with collision handling (ID bump + re-render).
- Completed IMP-AI-004: initial error codes in validate JSON/NDJSON; E200 multi-schema; per-schema cycle_policy (warn|error|ignore).
- Emitted locations for path hops and validate issues; added ACP-like protocol primitives + watch --json NDJSON events.
- Improved config loader E120 error to list conflicting schema sources; completed config/discovery splits (IMP-AI-009/010).
- Updated checklist; added comprehensive integration tests for new flows.


## Issues Encountered
<!-- Briefly, what is the user story or business need? Link to the full story, ADR, or spec for details. -->
- Editor flow UX: original new --edit wrote the note even if the editor was closed without saving. Resolved by editing a temp file first and only persisting when content/mtime changes (ADR-003c UX intent).
- Duplicate schema names: E120 was terse; enhanced error to include source file list for faster remediation across imports (ADR-006).
- Chrono locale/clock feature: required enabling chrono "clock" feature to support {{date}}/{{time}} without regressing build.
- Filename collisions: templating introduces variable filenames; ensured non-overwriting by ID bump + re-render loop.
- Consistency of outputs: added JSON/NDJSON shapes carefully to avoid breaking tests; ensured additive changes (ACP-aligned SessionUpdate, ContentBlock).


## Tests Added
<!-- Identify new tests and explain their coverage -->
- integration_new.rs
  - new_creates_note_from_template: verifies templating and title injection.
  - new_dry_run_does_not_write: ensures no file on dry-run.
  - new_twice_increments_id: verifies ID bump logic (ADR-001 style IDs).
  - new_print_body_prints: outputs rendered body (LLM-friendly).
  - new_filename_template_creates_expected_file: validates --filename-template rendering.
  - new_writes_to_specified_dest_base: verifies --dest-base selection.
- integration_init_schema.rs
  - init_appends_inline_schema & init_writes_separate_schema_and_imports: scaffolds inline/separate; import wiring.
  - idempotent runs: no duplicate schema or import entries.
- integration_cycle_policy.rs
  - cycles_warn_by_default_or_warn_policy: W240 warnings.
  - cycles_error_with_error_policy: E240 errors.


## Next Steps
<!-- How do we know this is done and working correctly? This should be testable from a user's perspective. -->
- Expand frontmatter merge rules (precedence policy) while guaranteeing id integrity; add per-schema precedence config.
- Document/enable per-schema filename_template usage in template.toml and README when docs stabilize.
- Normalize flags: add --graph-format; tighten global --format consistency (ADR-003).
- Search polish (schema/recent filters), status (doctor++) JSON view, and graph traversal over declared graph_edges.
